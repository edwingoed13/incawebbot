<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'inca-blue': '#0D8EE3',
            'inca-blue-dark': '#0B7BC7',
            'inca-gray': '#F8F9FA',
            'inca-text': '#333333',
          },
        },
      },
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <title>Inca Lake Travel Asistente Digital</title>
  <style>
    /* Estilos de respaldo para asegurar que los colores se apliquen */
    .bg-inca-blue { background-color: #0D8EE3 !important; }
    .bg-inca-blue-dark { background-color: #0B7BC7 !important; }
    .bg-inca-gray { background-color: #F8F9FA !important; }
    .text-inca-text { color: #333333 !important; }
    .focus\:ring-inca-blue:focus { --tw-ring-color: #0D8EE3 !important; }
    .focus\:border-inca-blue:focus { border-color: #0D8EE3 !important; }
    .hover\:bg-inca-blue-dark:hover { background-color: #0B7BC7 !important; }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-white">
  <header class="bg-inca-blue text-white py-4 sticky top-0 z-10">
    <div class="text-center">
      <h1 class="text-xl font-bold mb-2">Inca Lake Travel Assistant</h1>
      <div class="flex justify-center items-center space-x-4 text-sm">
        <a 
          href="https://wa.me/51982769453" 
          target="_blank" 
          class="flex items-center space-x-1 hover:text-green-400 transition-colors"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
          </svg>
          <span>+51 982 769 453</span>
        </a>
        <a 
          href="mailto:reservas@incalake.com" 
          class="flex items-center space-x-1 hover:text-blue-200 transition-colors"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
          </svg>
          <span>reservas@incalake.com</span>
        </a>
      </div>
    </div>
  </header>

  <main id="chat-container" class="flex-1 flex flex-col-reverse p-4 overflow-y-auto bg-white"></main>

  <form id="chat-form" class="flex p-4 bg-white border-t border-gray-200 sticky bottom-0 z-10 gap-2 flex-col sm:flex-row">
    <input
      type="text"
      id="user-input"
      placeholder="Escribe tu pregunta aquÃ­... / Type your question here..."
      autocomplete="off"
      required
      class="flex-1 p-3 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-inca-blue focus:border-inca-blue text-inca-text"
    />
    <button
      type="submit"
      class="px-4 py-3 text-base rounded-md bg-inca-blue text-white hover:bg-inca-blue-dark flex-shrink-0 transition-colors"
    >
      Send / Enviar
    </button>
  </form>

  <footer class="bg-inca-blue text-white text-center py-2 text-sm">
    &copy; <span id="current-year"></span> Inca Lake Travel Agency â€“ Powered by Edwin Flores 
  </footer>

  <script>
    // Actualizar el aÃ±o dinÃ¡micamente
    document.getElementById('current-year').textContent = new Date().getFullYear();

    const form = document.getElementById('chat-form');
    const input = document.getElementById('user-input');
    const chatContainer = document.getElementById('chat-container');

    const baseMessageClasses = 'p-4 my-2 max-w-[80%] rounded-lg shadow break-words';

    let sessionId = localStorage.getItem('chat_session_id');
    if (!sessionId) {
      sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('chat_session_id', sessionId);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      appendMessage(message, 'user');
      input.value = '';
      input.focus();

      const loadingMsg = document.createElement('div');
      loadingMsg.className = `${baseMessageClasses} self-start bg-inca-gray italic text-gray-500`;
      loadingMsg.textContent = 'Inca Lake Assistant is responding...';
      chatContainer.prepend(loadingMsg);

      try {
        const res = await fetch('http://localhost:5000/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, session_id: sessionId }),
        });

        if (chatContainer.contains(loadingMsg)) chatContainer.removeChild(loadingMsg);
        
        const botMsg = document.createElement('div');
        const botSideClasses = 'self-start bg-inca-gray text-inca-text';
        botMsg.className = `${baseMessageClasses} ${botSideClasses}`;
        chatContainer.prepend(botMsg);

        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let botResponse = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          botResponse += chunk;
          botMsg.innerHTML = marked.parse(botResponse);
        }
      } catch (err) {
        if (chatContainer.contains(loadingMsg)) chatContainer.removeChild(loadingMsg);
        console.error('Error fetching chat response:', err);
        appendMessage(`Sorry, there was an error: ${err.message || err}. Please try again.`, 'bot');
      }
    });

    function appendMessage(text, type) {
      const messageElem = document.createElement('div');
      const sideClasses = type === 'user' 
        ? 'self-end bg-inca-blue text-white' 
        : 'self-start bg-inca-gray text-inca-text';
      messageElem.className = `${baseMessageClasses} ${sideClasses}`;

      if (type === 'bot') {
        messageElem.innerHTML = marked.parse(text || 'ðŸ¤– No response');
      } else {
        messageElem.textContent = text;
      }

      chatContainer.prepend(messageElem);
    }
  </script>
</body>
</html>